<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>GeoGebra</title>
  <script src="https://www.geogebra.org/apps/deployggb.js"></script>
</head>
<body>
  <div id="ggb-element" style="width: 100%; height: 100%;"></div>
  <script>
    window.pydata = null;

    function ggbOnInit() {
      console.log("[GeoGebra] ggbOnInit вызван.");
      if (window.pydata) {
        console.log("[GeoGebra] Выполняется pydata:", window.pydata);
        try {
          eval(window.pydata);
        } catch (e) {
          console.error("[GeoGebra] Ошибка в pydata:", e);
        }
      } else {
        console.warn("[GeoGebra] pydata пуст.");
      }
    }

    function setGeoGebraCode(code) {
      console.log("[JS] setGeoGebraCode вызван с кодом:", code);
      window.pydata = code;
      if (typeof ggbApplet !== 'undefined' && ggbApplet) {
        console.log("[JS] ggbApplet доступен. Выполняем код немедленно.");
        try {
          eval(code);
        } catch (e) {
          console.error("[JS] Ошибка при eval(code):", e);
        }
      } else {
        console.warn("[JS] ggbApplet ещё не готов. Повтор через 800 мс.");
        setTimeout(() => {
          if (typeof ggbApplet !== 'undefined' && ggbApplet) {
            console.log("[JS] ggbApplet стал доступен. Повторный запуск.");
            try {
              eval(code);
            } catch (e) {
              console.error("[JS] Ошибка при повторном eval:", e);
            }
          } else {
            console.error("[JS] ggbApplet так и не загрузился!");
          }
        }, 800);
      }
    }

    var ggbApp = new GGBApplet({
      "appName": "graphing",
      "width": "100%",
      "height": "100%",
      "showToolBar": false,
      "showAlgebraInput": false,
      "showMenuBar": false,
      "enableLabelDrags": false,
      "enableShiftDragZoom": true,
      "enableRightClick": false,
      "language": "ru",
      "onLoad": "ggbOnInit"
    }, true);

    ggbApp.inject('ggb-element');
  </script>
</body>
</html>