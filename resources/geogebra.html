<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>GeoGebra</title>
  <script src="https://www.geogebra.org/apps/deployggb.js"></script>
</head>
<body>
  <div id="ggb-element" style="width: 100%; height: 100%;"></div>
  <script>
    window.pydata = null;
    let isGgbReady = false;

    function ggbOnInit() {
      console.log("[GeoGebra] ggbOnInit вызван.");
      isGgbReady = true;
      if (window.pydata) {
        console.log("[GeoGebra] Выполняется pydata при инициализации:", window.pydata);
        try {
          eval(window.pydata);
        } catch (e) {
          console.error("[GeoGebra] Ошибка в pydata при инициализации:", e);
        }
      } else {
        console.warn("[GeoGebra] pydata пуст при инициализации.");
      }
    }

    function setGeoGebraCode(code) {
      console.log("[JS] setGeoGebraCode вызван с кодом:", code);
      window.pydata = code;

      if (isGgbReady) {
        console.log("[JS] ggbApplet доступен. Выполняем код немедленно.");
        try {
            // Удаляем старые объекты перед выполнением нового кода
            ggbApplet.evalCommand("Delete[\"f\"]");
            ggbApplet.evalCommand("Delete[\"Roots\"]");
            ggbApplet.evalCommand("ZoomStandard[]");
            ggbApplet.evalCommand("ShowAxes = true");
            // Выполняем основной код
            eval(code);
        } catch (e) {
          console.error("[JS] Ошибка при eval(code):", e);
        }
      } else {
        console.warn("[JS] ggbApplet ещё не готов. Ожидание...");
        // Устанавливаем таймер для повторной попытки
        const timer = setInterval(() => {
          if (isGgbReady) {
            console.log("[JS] ggbApplet стал доступен. Выполняем код.");
            clearInterval(timer);
            try {
                // Удаляем старые объекты перед выполнением нового кода
                ggbApplet.evalCommand("Delete[\"f\"]");
                ggbApplet.evalCommand("Delete[\"Roots\"]");
                ggbApplet.evalCommand("ZoomStandard[]");
                ggbApplet.evalCommand("ShowAxes = true");
                // Выполняем основной код
                eval(code);
            } catch (e) {
              console.error("[JS] Ошибка при повторном eval:", e);
            }
          }
        }, 500);
      }
    }

    var ggbApp = new GGBApplet({
      "appName": "graphing",
      "width": "100%",
      "height": "100%",
      "showToolBar": false,
      "showAlgebraInput": false,
      "showMenuBar": false,
      "enableLabelDrags": false,
      "enableShiftDragZoom": true,
      "enableRightClick": false,
      "language": "ru",
      "onLoad": "ggbOnInit"
    }, true);
    ggbApp.inject('ggb-element');
  </script>
</body>
</html>